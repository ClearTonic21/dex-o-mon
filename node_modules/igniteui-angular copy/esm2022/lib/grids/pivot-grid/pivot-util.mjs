import { CurrentResourceStrings } from '../../core/i18n/resources';
import { DataUtil, GridColumnDataType } from '../../data-operations/data-util';
import { FilteringLogic } from '../../data-operations/filtering-expression.interface';
import { FilteringExpressionsTree } from '../../data-operations/filtering-expressions-tree';
import { IgxSorting } from '../common/strategy';
import { IgxPivotAggregate, IgxPivotDateAggregate, IgxPivotNumericAggregate, IgxPivotTimeAggregate } from './pivot-grid-aggregate';
import { PivotDimensionType } from './pivot-grid.interface';
export class PivotUtil {
    // go through all children and apply new dimension groups as child
    static processGroups(recs, dimension, pivotKeys, cloneStrategy) {
        for (const rec of recs) {
            // process existing children
            if (rec.children && rec.children.size > 0) {
                // process hierarchy in dept
                rec.children.forEach((values) => {
                    this.processGroups(values, dimension, pivotKeys, cloneStrategy);
                });
            }
            // add children for current dimension
            const hierarchyFields = PivotUtil
                .getFieldsHierarchy(rec.records, [dimension], PivotDimensionType.Row, pivotKeys, cloneStrategy);
            const siblingData = PivotUtil
                .processHierarchy(hierarchyFields, pivotKeys, 0);
            rec.children.set(dimension.memberName, siblingData);
        }
    }
    static flattenGroups(data, dimension, expansionStates, defaultExpand, parent, parentRec) {
        for (let i = 0; i < data.length; i++) {
            const rec = data[i];
            const field = dimension.memberName;
            if (!field) {
                continue;
            }
            let recordsData = rec.children.get(field);
            if (!recordsData && parent) {
                // check parent
                recordsData = rec.children.get(parent.memberName);
                if (recordsData) {
                    dimension = parent;
                }
            }
            if (parentRec) {
                parentRec.dimensionValues.forEach((value, key) => {
                    if (parent.memberName !== key) {
                        rec.dimensionValues.set(key, value);
                        const dim = parentRec.dimensions.find(x => x.memberName === key);
                        rec.dimensions.unshift(dim);
                    }
                });
            }
            const expansionRowKey = PivotUtil.getRecordKey(rec, dimension);
            const isExpanded = expansionStates.get(expansionRowKey) === undefined ?
                defaultExpand :
                expansionStates.get(expansionRowKey);
            const shouldExpand = isExpanded || !dimension.childLevel || !rec.dimensionValues.get(dimension.memberName);
            if (shouldExpand && recordsData) {
                if (dimension.childLevel) {
                    this.flattenGroups(recordsData, dimension.childLevel, expansionStates, defaultExpand, dimension, rec);
                }
                else {
                    // copy parent values and dims in child
                    recordsData.forEach(x => {
                        rec.dimensionValues.forEach((value, key) => {
                            if (dimension.memberName !== key) {
                                x.dimensionValues.set(key, value);
                                const dim = rec.dimensions.find(y => y.memberName === key);
                                x.dimensions.unshift(dim);
                            }
                        });
                    });
                }
                data.splice(i + 1, 0, ...recordsData);
                i += recordsData.length;
            }
        }
    }
    static assignLevels(dims) {
        for (const dim of dims) {
            let currDim = dim;
            let lvl = 0;
            while (currDim.childLevel) {
                currDim.level = lvl;
                currDim = currDim.childLevel;
                lvl++;
            }
            currDim.level = lvl;
        }
    }
    static getFieldsHierarchy(data, dimensions, dimensionType, pivotKeys, cloneStrategy) {
        const hierarchy = new Map();
        for (const rec of data) {
            const vals = dimensionType === PivotDimensionType.Column ?
                this.extractValuesForColumn(dimensions, rec, pivotKeys) :
                this.extractValuesForRow(dimensions, rec, pivotKeys, cloneStrategy);
            for (const [_key, val] of vals) { // this should go in depth also vals.children
                if (hierarchy.get(val.value) != null) {
                    this.applyHierarchyChildren(hierarchy, val, rec, pivotKeys);
                }
                else {
                    hierarchy.set(val.value, cloneStrategy.clone(val));
                    this.applyHierarchyChildren(hierarchy, val, rec, pivotKeys);
                }
            }
        }
        return hierarchy;
    }
    static sort(data, expressions, sorting = new IgxSorting()) {
        data.forEach(rec => {
            const children = rec.children;
            if (children) {
                children.forEach(x => {
                    this.sort(x, expressions, sorting);
                });
            }
        });
        return DataUtil.sort(data, expressions, sorting);
    }
    static extractValueFromDimension(dim, recData) {
        return dim.memberFunction ? dim.memberFunction.call(null, recData) : recData[dim.memberName];
    }
    static getDimensionDepth(dim) {
        let lvl = 0;
        while (dim.childLevel) {
            lvl++;
            dim = dim.childLevel;
        }
        return lvl;
    }
    static extractValuesForRow(dims, recData, pivotKeys, cloneStrategy) {
        const values = new Map();
        for (const col of dims) {
            if (recData[pivotKeys.level] && recData[pivotKeys.level] > 0) {
                const childData = recData[pivotKeys.records];
                return this.getFieldsHierarchy(childData, [col], PivotDimensionType.Row, pivotKeys, cloneStrategy);
            }
            const value = this.extractValueFromDimension(col, recData);
            const objValue = {};
            objValue['value'] = value;
            objValue['dimension'] = col;
            if (col.childLevel) {
                const childValues = this.extractValuesForRow([col.childLevel], recData, pivotKeys, cloneStrategy);
                objValue[pivotKeys.children] = childValues;
            }
            values.set(value, objValue);
        }
        return values;
    }
    static extractValuesForColumn(dims, recData, pivotKeys, path = []) {
        const vals = new Map();
        let lvlCollection = vals;
        const flattenedDims = this.flatten(dims);
        for (const col of flattenedDims) {
            const value = this.extractValueFromDimension(col, recData);
            path.push(value);
            const newValue = path.join(pivotKeys.columnDimensionSeparator);
            const newObj = { value: newValue, expandable: col.expandable, children: null, dimension: col };
            if (!newObj.children) {
                newObj.children = new Map();
            }
            lvlCollection.set(newValue, newObj);
            lvlCollection = newObj.children;
        }
        return vals;
    }
    static flatten(arr, lvl = 0) {
        const newArr = arr.reduce((acc, item) => {
            item.level = lvl;
            acc.push(item);
            if (item.childLevel) {
                item.expandable = true;
                acc = acc.concat(this.flatten([item.childLevel], lvl + 1));
            }
            return acc;
        }, []);
        return newArr;
    }
    static applyAggregations(rec, hierarchies, values, pivotKeys) {
        if (hierarchies.size === 0) {
            // no column groups
            const aggregationResult = this.aggregate(rec.records, values);
            this.applyAggregationRecordData(aggregationResult, undefined, rec, pivotKeys);
            return;
        }
        hierarchies.forEach((hierarchy) => {
            const children = hierarchy[pivotKeys.children];
            if (children && children.size > 0) {
                this.applyAggregations(rec, children, values, pivotKeys);
                const childRecords = this.collectRecords(children, pivotKeys);
                hierarchy[pivotKeys.aggregations] = this.aggregate(childRecords, values);
                this.applyAggregationRecordData(hierarchy[pivotKeys.aggregations], hierarchy.value, rec, pivotKeys);
            }
            else if (hierarchy[pivotKeys.records]) {
                hierarchy[pivotKeys.aggregations] = this.aggregate(hierarchy[pivotKeys.records], values);
                this.applyAggregationRecordData(hierarchy[pivotKeys.aggregations], hierarchy.value, rec, pivotKeys);
            }
        });
    }
    static applyAggregationRecordData(aggregationData, groupName, rec, pivotKeys) {
        const aggregationKeys = Object.keys(aggregationData);
        if (aggregationKeys.length > 1) {
            aggregationKeys.forEach((key) => {
                const aggregationKey = groupName ? groupName + pivotKeys.columnDimensionSeparator + key : key;
                rec.aggregationValues.set(aggregationKey, aggregationData[key]);
            });
        }
        else if (aggregationKeys.length === 1) {
            const aggregationKey = aggregationKeys[0];
            rec.aggregationValues.set(groupName || aggregationKey, aggregationData[aggregationKey]);
        }
    }
    static aggregate(records, values) {
        const result = {};
        for (const pivotValue of values) {
            const aggregator = PivotUtil.getAggregatorForType(pivotValue.aggregate, pivotValue.dataType);
            if (!aggregator) {
                throw CurrentResourceStrings.GridResStrings.igx_grid_pivot_no_aggregator.replace("{0}", pivotValue.member);
            }
            result[pivotValue.member] = aggregator(records.map(r => r[pivotValue.member]), records);
        }
        return result;
    }
    static getAggregatorForType(aggregate, dataType) {
        let aggregator = aggregate.aggregator;
        if (aggregate.aggregatorName) {
            let aggregators = IgxPivotNumericAggregate.aggregators();
            if (!dataType || dataType === 'date' || dataType === 'dateTime') {
                aggregators = aggregators.concat(IgxPivotDateAggregate.aggregators());
            }
            else if (dataType === 'time') {
                aggregators = aggregators.concat(IgxPivotTimeAggregate.aggregators());
            }
            aggregator = aggregators.find(x => x.key === aggregate.aggregatorName)?.aggregator;
        }
        return aggregator;
    }
    static processHierarchy(hierarchies, pivotKeys, level = 0, rootData = false) {
        const flatData = [];
        hierarchies.forEach((h, key) => {
            const field = h.dimension.memberName;
            const rec = {
                dimensionValues: new Map(),
                aggregationValues: new Map(),
                children: new Map(),
                dimensions: [h.dimension]
            };
            rec.dimensionValues.set(field, key);
            if (h[pivotKeys.records]) {
                rec.records = this.getDirectLeafs(h[pivotKeys.records]);
            }
            rec.level = level;
            flatData.push(rec);
            if (h[pivotKeys.children] && h[pivotKeys.children].size > 0) {
                const nestedData = this.processHierarchy(h[pivotKeys.children], pivotKeys, level + 1, rootData);
                rec.records = this.getDirectLeafs(nestedData);
                rec.children.set(field, nestedData);
            }
        });
        return flatData;
    }
    static getDirectLeafs(records) {
        let leafs = [];
        for (const rec of records) {
            if (rec.records) {
                const data = rec.records.filter(x => !x.records && leafs.indexOf(x) === -1);
                leafs = leafs.concat(data);
            }
            else {
                leafs.push(rec);
            }
        }
        return leafs;
    }
    static getRecordKey(rec, currentDim) {
        const parentFields = [];
        const currentDimIndex = rec.dimensions.findIndex(x => x.memberName === currentDim.memberName) + 1;
        const prevDims = rec.dimensions.slice(0, currentDimIndex);
        for (const prev of prevDims) {
            const prevValue = rec.dimensionValues.get(prev.memberName);
            parentFields.push(prevValue);
        }
        return parentFields.join('-');
    }
    static buildExpressionTree(config) {
        const allDimensions = (config?.rows || []).concat((config?.columns || [])).concat(config?.filters || []).filter(x => x !== null && x !== undefined);
        const enabledDimensions = allDimensions.filter(x => x && x.enabled);
        const expressionsTree = new FilteringExpressionsTree(FilteringLogic.And);
        // add expression trees from all filters
        PivotUtil.flatten(enabledDimensions).forEach((x) => {
            if (x.filter && x.filter.filteringOperands) {
                expressionsTree.filteringOperands.push(...x.filter.filteringOperands);
            }
        });
        return expressionsTree;
    }
    static collectRecords(children, pivotKeys) {
        let result = [];
        children.forEach(value => result = result.concat(value[pivotKeys.records]));
        return result;
    }
    static applyHierarchyChildren(hierarchy, val, rec, pivotKeys) {
        const recordsKey = pivotKeys.records;
        const childKey = pivotKeys.children;
        const childCollection = val[childKey];
        const hierarchyValue = hierarchy.get(val.value);
        if (Array.isArray(hierarchyValue[childKey])) {
            hierarchyValue[childKey] = new Map();
        }
        if (!childCollection || childCollection.size === 0) {
            const dim = hierarchyValue.dimension;
            const isValid = this.extractValueFromDimension(dim, rec) === val.value;
            if (isValid) {
                if (hierarchyValue[recordsKey]) {
                    hierarchyValue[recordsKey].push(rec);
                }
                else {
                    hierarchyValue[recordsKey] = [rec];
                }
            }
        }
        else {
            const hierarchyChild = hierarchyValue[childKey];
            for (const [_key, child] of childCollection) {
                let hierarchyChildValue = hierarchyChild.get(child.value);
                if (!hierarchyChildValue) {
                    hierarchyChild.set(child.value, child);
                    hierarchyChildValue = child;
                }
                if (hierarchyChildValue[recordsKey]) {
                    const copy = Object.assign({}, rec);
                    if (rec[recordsKey]) {
                        // not all nested children are valid
                        const nestedValue = hierarchyChildValue.value;
                        const dimension = hierarchyChildValue.dimension;
                        const validRecs = rec[recordsKey].filter(x => this.extractValueFromDimension(dimension, x) === nestedValue);
                        copy[recordsKey] = validRecs;
                    }
                    hierarchyChildValue[recordsKey].push(copy);
                }
                else {
                    hierarchyChildValue[recordsKey] = [rec];
                }
                if (child[childKey] && child[childKey].size > 0) {
                    this.applyHierarchyChildren(hierarchyChild, child, rec, pivotKeys);
                }
            }
        }
    }
    static getAggregateList(val, grid) {
        if (!val.aggregateList) {
            let defaultAggr = this.getAggregatorsForValue(val, grid);
            const isDefault = defaultAggr.find((x) => x.key === val.aggregate.key);
            // resolve custom aggregations
            if (!isDefault && grid.data[0][val.member] !== undefined) {
                // if field exists, then we can apply default aggregations and add the custom one.
                defaultAggr.unshift(val.aggregate);
            }
            else if (!isDefault) {
                // otherwise this is a custom aggregation that is not compatible
                // with the defaults, since it operates on field that is not in the data
                // leave only the custom one.
                defaultAggr = [val.aggregate];
            }
            val.aggregateList = defaultAggr;
        }
        return val.aggregateList;
    }
    static getAggregatorsForValue(value, grid) {
        const dataType = value.dataType || grid.resolveDataTypes(grid.data[0][value.member]);
        switch (dataType) {
            case GridColumnDataType.Number:
            case GridColumnDataType.Currency:
                return IgxPivotNumericAggregate.aggregators();
            case GridColumnDataType.Date:
            case GridColumnDataType.DateTime:
                return IgxPivotDateAggregate.aggregators();
            case GridColumnDataType.Time:
                return IgxPivotTimeAggregate.aggregators();
            default:
                return IgxPivotAggregate.aggregators();
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGl2b3QtdXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2lnbml0ZXVpLWFuZ3VsYXIvc3JjL2xpYi9ncmlkcy9waXZvdC1ncmlkL3Bpdm90LXV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFbkUsT0FBTyxFQUFFLFFBQVEsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQy9FLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxzREFBc0QsQ0FBQztBQUN0RixPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxrREFBa0QsQ0FBQztBQUc1RixPQUFPLEVBQXdCLFVBQVUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3RFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxxQkFBcUIsRUFBRSx3QkFBd0IsRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ25JLE9BQU8sRUFBcUcsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUUvSixNQUFNLE9BQU8sU0FBUztJQUVsQixrRUFBa0U7SUFDM0QsTUFBTSxDQUFDLGFBQWEsQ0FBQyxJQUF3QixFQUFFLFNBQTBCLEVBQUUsU0FBcUIsRUFBRSxhQUFpQztRQUN0SSxLQUFLLE1BQU0sR0FBRyxJQUFJLElBQUksRUFBRTtZQUNwQiw0QkFBNEI7WUFDNUIsSUFBSSxHQUFHLENBQUMsUUFBUSxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxHQUFHLENBQUMsRUFBRTtnQkFDdkMsNEJBQTRCO2dCQUM1QixHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO29CQUM1QixJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLGFBQWEsQ0FBQyxDQUFDO2dCQUNwRSxD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QyxhQUFhLENBQUM7SUFDN0IsQ0FBQztJQUVNLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxLQUFrQixFQUFFLElBQW1CO1FBQ3hFLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDckYsUUFBUSxRQUFRLEVBQUU7WUFDZCxLQUFLLGtCQUFrQixDQUFDLE1BQU0sQ0FBQztZQUMvQixLQUFLLGtCQUFrQixDQUFDLFFBQVE7Z0JBQzVCLE9BQU8sd0JBQXdCLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDbEQsS0FBSyxrQkFBa0IsQ0FBQyxJQUFJLENBQUM7WUFDN0IsS0FBSyxrQkFBa0IsQ0FBQyxRQUFRO2dCQUM1QixPQUFPLHFCQUFxQixDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQy9DLEtBQUssa0JBQWtCLENBQUMsSUFBSTtnQkFDeEIsT0FBTyxxQkFBcUIsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUMvQztnQkFDSSxPQUFPLGlCQUFpQixDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQzlDO0lBQ0wsQ0FBQztDQUdKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ3VycmVudFJlc291cmNlU3RyaW5ncyB9IGZyb20gJy4uLy4uL2NvcmUvaTE4bi9yZXNvdXJjZXMnO1xuaW1wb3J0IHsgSURhdGFDbG9uZVN0cmF0ZWd5IH0gZnJvbSAnLi4vLi4vZGF0YS1vcGVyYXRpb25zL2RhdGEtY2xvbmUtc3RyYXRlZ3knO1xuaW1wb3J0IHsgRGF0YVV0aWwsIEdyaWRDb2x1bW5EYXRhVHlwZSB9IGZyb20gJy4uLy4uL2RhdGEtb3BlcmF0aW9ucy9kYXRhLXV0aWwnO1xuaW1wb3J0IHsgRmlsdGVyaW5nTG9naWMgfSBmcm9tICcuLi8uLi9kYXRhLW9wZXJhdGlvbnMvZmlsdGVyaW5nLWV4cHJlc3Npb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IEZpbHRlcmluZ0V4cHJlc3Npb25zVHJlZSB9IGZyb20gJy4uLy4uL2RhdGEtb3BlcmF0aW9ucy9maWx0ZXJpbmctZXhwcmVzc2lvbnMtdHJlZSc7XG5pbXBvcnQgeyBJU29ydGluZ0V4cHJlc3Npb24gfSBmcm9tICcuLi8uLi9kYXRhLW9wZXJhdGlvbnMvc29ydGluZy1zdHJhdGVneSc7XG5pbXBvcnQgeyBQaXZvdEdyaWRUeXBlIH0gZnJvbSAnLi4vY29tbW9uL2dyaWQuaW50ZXJmYWNlJztcbmltcG9ydCB7IElHcmlkU29ydGluZ1N0cmF0ZWd5LCBJZ3hTb3J0aW5nIH0gZnJvbSAnLi4vY29tbW9uL3N0cmF0ZWd5JztcbmltcG9ydCB7IElneFBpdm90QWdncmVnYXRlLCBJZ3hQaXZvdERhdGVBZ2dyZWdhdGUsIElneFBpdm90TnVtZXJpY0FnZ3JlZ2F0ZSwgSWd4UGl2b3RUaW1lQWdncmVnYXRlIH0gZnJvbSAnLi9waXZvdC1ncmlkLWFnZ3JlZ2F0ZSc7XG5pbXBvcnQgeyBJUGl2b3RBZ2dyZWdhdG9yLCBJUGl2b3RDb25maWd1cmF0aW9uLCBJUGl2b3REaW1lbnNpb24sIElQaXZvdEdyaWRSZWNvcmQsIElQaXZvdEtleXMsIElQaXZvdFZhbHVlLCBQaXZvdERpbWVuc2lvblR5cGUgfSBmcm9tICcuL3Bpdm90LWdyaWQuaW50ZXJmYWNlJztcblxuZXhwb3J0IGNsYXNzIFBpdm90VXRpbCB7XG5cbiAgICAvLyBnbyB0aHJvdWdoIGFsbCBjaGlsZHJlbiBhbmQgYXBwbHkgbmV3IGRpbWVuc2lvbiBncm91cHMgYXMgY2hpbGRcbiAgICBwdWJsaWMgc3RhdGljIHByb2Nlc3NHcm91cHMocmVjczogSVBpdm90R3JpZFJlY29yZFtdLCBkaW1lbnNpb246IElQaXZvdERpbWVuc2lvbiwgcGl2b3RLZXlzOiBJUGl2b3RLZXlzLCBjbG9uZVN0cmF0ZWd5OiBJRGF0YUNsb25lU3RyYXRlZ3kpIHtcbiAgICAgICAgZm9yIChjb25zdCByZWMgb2YgcmVjcykge1xuICAgICAgICAgICAgLy8gcHJvY2VzcyBleGlzdGluZyBjaGlsZHJlblxuICAgICAgICAgICAgaWYgKHJlYy5jaGlsZHJlbiAmJiByZWMuY2hpbGRyZW4uc2l6ZSA+IDApIHtcbiAgICAgICAgICAgICAgICAvLyBwcm9jZXNzIGhpZXJhcmNoeSBpbiBkZXB0XG4gICAgICAgICAgICAgICAgcmVjLmNoaWxkcmVuLmZvckVhY2goKHZhbHVlcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NHcm91cHModmFsdWVzLCBkaW1lbnNpb24sIHBpdm90S2V5cywgY2xvbmVTdHJhdGVneSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBhZGQgY2hpbGRyZW4gZm9yIGN1cnJlbnQgZGltZW5zaW9uXG4gICAgICAgICAgICBjb25zdCBoaWVyYXJjaHlGaWVsZHMgPSBQaXZvdFV0aWxcbiAgICAgICAgICAgICAgICAuZ2V0RmllbGRzSGllcmFyY2h5KHJlYy5yZWNvcmRzLCBbZGltZW5zaW9uXSwgUGl2b3REaW1lbnNpb25UeXBlLlJvdywgcGl2b3RLZXlzLCBjbG9uZVN0cmF0ZWd5KTtcbiAgICAgICAgICAgIGNvbnN0IHNpYmxpbmdEYXRhID0gUGl2b3RVdGlsXG4gICAgICAgICAgICAgICAgLnByb2Nlc3NIaWVyYXJjaHkoaGllcmFyY2h5RmllbGRzLCBwaXZvdEtleXMsIDApO1xuICAgICAgICAgICAgcmVjLmNoaWxkcmVuLnNldChkaW1lbnNpb24ubWVtYmVyTmFtZSwgc2libGluZ0RhdGEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBmbGF0dGVuR3JvdXBzKGRhdGE6IElQaXZvdEdyaWRSZWNvcmRbXSwgZGltZW5zaW9uOiBJUGl2b3REaW1lbnNpb24sIGV4cGFuc2lvblN0YXRlcywgZGVmYXVsdEV4cGFuZDogYm9vbGVhbiwgcGFyZW50PzogSVBpdm90RGltZW5zaW9uLCBwYXJlbnRSZWM/OiBJUGl2b3RHcmlkUmVjb3JkKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgY29uc3QgcmVjID0gZGF0YVtpXTtcbiAgICAgICAgICAgIGNvbnN0IGZpZWxkID0gZGltZW5zaW9uLm1lbWJlck5hbWU7XG4gICAgICAgICAgICBpZiAoIWZpZWxkKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCByZWNvcmRzRGF0YSA9IHJlYy5jaGlsZHJlbi5nZXQoZmllbGQpO1xuICAgICAgICAgICAgaWYgKCFyZWNvcmRzRGF0YSAmJiBwYXJlbnQpIHtcbiAgICAgICAgICAgICAgICAvLyBjaGVjayBwYXJlbnRcbiAgICAgICAgICAgICAgICByZWNvcmRzRGF0YSA9IHJlYy5jaGlsZHJlbi5nZXQocGFyZW50Lm1lbWJlck5hbWUpO1xuICAgICAgICAgICAgICAgIGlmIChyZWNvcmRzRGF0YSkge1xuICAgICAgICAgICAgICAgICAgICBkaW1lbnNpb24gPSBwYXJlbnQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocGFyZW50UmVjKSB7XG4gICAgICAgICAgICAgICAgcGFyZW50UmVjLmRpbWVuc2lvblZhbHVlcy5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQubWVtYmVyTmFtZSAhPT0ga2V5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWMuZGltZW5zaW9uVmFsdWVzLnNldChrZXksIHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpbSA9IHBhcmVudFJlYy5kaW1lbnNpb25zLmZpbmQoeCA9PiB4Lm1lbWJlck5hbWUgPT09IGtleSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWMuZGltZW5zaW9ucy51bnNoaWZ0KGRpbSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgIGNvbnN0IGV4cGFuc2lvblJvd0tleSA9IFBpdm90VXRpbC5nZXRSZWNvcmRLZXkocmVjLCBkaW1lbnNpb24pO1xuICAgICAgICAgICAgY29uc3QgaXNFeHBhbmRlZCA9IGV4cGFuc2lvblN0YXRlcy5nZXQoZXhwYW5zaW9uUm93S2V5KSA9PT0gdW5kZWZpbmVkID9cbiAgICAgICAgICAgICAgICBkZWZhdWx0RXhwYW5kIDpcbiAgICAgICAgICAgICAgICBleHBhbnNpb25TdGF0ZXMuZ2V0KGV4cGFuc2lvblJvd0tleSk7XG4gICAgICAgICAgICBjb25zdCBzaG91bGRFeHBhbmQgPSBpc0V4cGFuZGVkIHx8ICFkaW1lbnNpb24uY2hpbGRMZXZlbCB8fCAhcmVjLmRpbWVuc2lvblZhbHVlcy5nZXQoZGltZW5zaW9uLm1lbWJlck5hbWUpO1xuICAgICAgICAgICAgaWYgKHNob3VsZEV4cGFuZCAmJiByZWNvcmRzRGF0YSkge1xuICAgICAgICAgICAgICAgIGlmIChkaW1lbnNpb24uY2hpbGRMZXZlbCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZsYXR0ZW5Hcm91cHMocmVjb3Jkc0RhdGEsIGRpbWVuc2lvbi5jaGlsZExldmVsLCBleHBhbnNpb25TdGF0ZXMsIGRlZmF1bHRFeHBhbmQsIGRpbWVuc2lvbiwgcmVjKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyBjb3B5IHBhcmVudCB2YWx1ZXMgYW5kIGRpbXMgaW4gY2hpbGRcbiAgICAgICAgICAgICAgICAgICAgcmVjb3Jkc0RhdGEuZm9yRWFjaCh4ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlYy5kaW1lbnNpb25WYWx1ZXMuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaW1lbnNpb24ubWVtYmVyTmFtZSAhPT0ga2V5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHguZGltZW5zaW9uVmFsdWVzLnNldChrZXksIHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGltID0gcmVjLmRpbWVuc2lvbnMuZmluZCh5ID0+IHkubWVtYmVyTmFtZSA9PT0ga2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeC5kaW1lbnNpb25zLnVuc2hpZnQoZGltKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBkYXRhLnNwbGljZShpICsgMSwgMCwgLi4ucmVjb3Jkc0RhdGEpO1xuICAgICAgICAgICAgICAgIGkgKz0gcmVjb3Jkc0RhdGEubGVuZ3RoO1xuXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIHN0YXRpYyBhc3NpZ25MZXZlbHMoZGltcykge1xuICAgICAgICBmb3IgKGNvbnN0IGRpbSBvZiBkaW1zKSB7XG4gICAgICAgICAgICBsZXQgY3VyckRpbSA9IGRpbTtcbiAgICAgICAgICAgIGxldCBsdmwgPSAwO1xuICAgICAgICAgICAgd2hpbGUgKGN1cnJEaW0uY2hpbGRMZXZlbCkge1xuICAgICAgICAgICAgICAgIGN1cnJEaW0ubGV2ZWwgPSBsdmw7XG4gICAgICAgICAgICAgICAgY3VyckRpbSA9IGN1cnJEaW0uY2hpbGRMZXZlbDtcbiAgICAgICAgICAgICAgICBsdmwrKztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGN1cnJEaW0ubGV2ZWwgPSBsdmw7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIHN0YXRpYyBnZXRGaWVsZHNIaWVyYXJjaHkoZGF0YTogYW55W10sIGRpbWVuc2lvbnM6IElQaXZvdERpbWVuc2lvbltdLFxuICAgICAgICBkaW1lbnNpb25UeXBlOiBQaXZvdERpbWVuc2lvblR5cGUsIHBpdm90S2V5czogSVBpdm90S2V5cywgY2xvbmVTdHJhdGVneTogSURhdGFDbG9uZVN0cmF0ZWd5KTogTWFwPHN0cmluZywgYW55PiB7XG4gICAgICAgIGNvbnN0IGhpZXJhcmNoeSA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XG4gICAgICAgIGZvciAoY29uc3QgcmVjIG9mIGRhdGEpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHMgPSBkaW1lbnNpb25UeXBlID09PSBQaXZvdERpbWVuc2lvblR5cGUuQ29sdW1uID9cbiAgICAgICAgICAgICAgICB0aGlzLmV4dHJhY3RWYWx1ZXNGb3JDb2x1bW4oZGltZW5zaW9ucywgcmVjLCBwaXZvdEtleXMpIDpcbiAgICAgICAgICAgICAgICB0aGlzLmV4dHJhY3RWYWx1ZXNGb3JSb3coZGltZW5zaW9ucywgcmVjLCBwaXZvdEtleXMsIGNsb25lU3RyYXRlZ3kpO1xuICAgICAgICAgICAgZm9yIChjb25zdCBbX2tleSwgdmFsXSBvZiB2YWxzKSB7IC8vIHRoaXMgc2hvdWxkIGdvIGluIGRlcHRoIGFsc28gdmFscy5jaGlsZHJlblxuICAgICAgICAgICAgICAgIGlmIChoaWVyYXJjaHkuZ2V0KHZhbC52YWx1ZSkgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5SGllcmFyY2h5Q2hpbGRyZW4oaGllcmFyY2h5LCB2YWwsIHJlYywgcGl2b3RLZXlzKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBoaWVyYXJjaHkuc2V0KHZhbC52YWx1ZSwgY2xvbmVTdHJhdGVneS5jbG9uZSh2YWwpKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseUhpZXJhcmNoeUNoaWxkcmVuKGhpZXJhcmNoeSwgdmFsLCByZWMsIHBpdm90S2V5cyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBoaWVyYXJjaHk7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBzb3J0KGRhdGE6IElQaXZvdEdyaWRSZWNvcmRbXSwgZXhwcmVzc2lvbnM6IElTb3J0aW5nRXhwcmVzc2lvbltdLCBzb3J0aW5nOiBJR3JpZFNvcnRpbmdTdHJhdGVneSA9IG5ldyBJZ3hTb3J0aW5nKCkpOiBhbnlbXSB7XG4gICAgICAgIGRhdGEuZm9yRWFjaChyZWMgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2hpbGRyZW4gPSByZWMuY2hpbGRyZW47XG4gICAgICAgICAgICBpZiAoY2hpbGRyZW4pIHtcbiAgICAgICAgICAgICAgICBjaGlsZHJlbi5mb3JFYWNoKHggPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNvcnQoeCwgZXhwcmVzc2lvbnMsIHNvcnRpbmcpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIERhdGFVdGlsLnNvcnQoZGF0YSwgZXhwcmVzc2lvbnMsIHNvcnRpbmcpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZXh0cmFjdFZhbHVlRnJvbURpbWVuc2lvbihkaW06IElQaXZvdERpbWVuc2lvbiwgcmVjRGF0YTogYW55KSB7XG4gICAgICAgIHJldHVybiBkaW0ubWVtYmVyRnVuY3Rpb24gPyBkaW0ubWVtYmVyRnVuY3Rpb24uY2FsbChudWxsLCByZWNEYXRhKSA6IHJlY0RhdGFbZGltLm1lbWJlck5hbWVdO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0RGltZW5zaW9uRGVwdGgoZGltOiBJUGl2b3REaW1lbnNpb24pOiBudW1iZXIge1xuICAgICAgICBsZXQgbHZsID0gMDtcbiAgICAgICAgd2hpbGUgKGRpbS5jaGlsZExldmVsKSB7XG4gICAgICAgICAgICBsdmwrKztcbiAgICAgICAgICAgIGRpbSA9IGRpbS5jaGlsZExldmVsO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsdmw7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBleHRyYWN0VmFsdWVzRm9yUm93KGRpbXM6IElQaXZvdERpbWVuc2lvbltdLCByZWNEYXRhOiBhbnksIHBpdm90S2V5czogSVBpdm90S2V5cywgY2xvbmVTdHJhdGVneTogSURhdGFDbG9uZVN0cmF0ZWd5KSB7XG4gICAgICAgIGNvbnN0IHZhbHVlcyA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XG4gICAgICAgIGZvciAoY29uc3QgY29sIG9mIGRpbXMpIHtcbiAgICAgICAgICAgIGlmIChyZWNEYXRhW3Bpdm90S2V5cy5sZXZlbF0gJiYgcmVjRGF0YVtwaXZvdEtleXMubGV2ZWxdID4gMCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkRGF0YSA9IHJlY0RhdGFbcGl2b3RLZXlzLnJlY29yZHNdO1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEZpZWxkc0hpZXJhcmNoeShjaGlsZERhdGEsIFtjb2xdLCBQaXZvdERpbWVuc2lvblR5cGUuUm93LCBwaXZvdEtleXMsIGNsb25lU3RyYXRlZ3kpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZXh0cmFjdFZhbHVlRnJvbURpbWVuc2lvbihjb2wsIHJlY0RhdGEpO1xuICAgICAgICAgICAgY29uc3Qgb2JqVmFsdWUgPSB7fTtcbiAgICAgICAgICAgIG9ialZhbHVlWyd2YWx1ZSddID0gdmFsdWU7XG4gICAgICAgICAgICBvYmpWYWx1ZVsnZGltZW5zaW9uJ10gPSBjb2w7XG4gICAgICAgICAgICBpZiAoY29sLmNoaWxkTGV2ZWwpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjaGlsZFZhbHVlcyA9IHRoaXMuZXh0cmFjdFZhbHVlc0ZvclJvdyhbY29sLmNoaWxkTGV2ZWxdLCByZWNEYXRhLCBwaXZvdEtleXMsIGNsb25lU3RyYXRlZ3kpO1xuICAgICAgICAgICAgICAgIG9ialZhbHVlW3Bpdm90S2V5cy5jaGlsZHJlbl0gPSBjaGlsZFZhbHVlcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhbHVlcy5zZXQodmFsdWUsIG9ialZhbHVlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB2YWx1ZXM7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBleHRyYWN0VmFsdWVzRm9yQ29sdW1uKGRpbXM6IElQaXZvdERpbWVuc2lvbltdLCByZWNEYXRhOiBhbnksIHBpdm90S2V5czogSVBpdm90S2V5cywgcGF0aCA9IFtdKSB7XG4gICAgICAgIGNvbnN0IHZhbHMgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xuICAgICAgICBsZXQgbHZsQ29sbGVjdGlvbiA9IHZhbHM7XG4gICAgICAgIGNvbnN0IGZsYXR0ZW5lZERpbXMgPSB0aGlzLmZsYXR0ZW4oZGltcyk7XG4gICAgICAgIGZvciAoY29uc3QgY29sIG9mIGZsYXR0ZW5lZERpbXMpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5leHRyYWN0VmFsdWVGcm9tRGltZW5zaW9uKGNvbCwgcmVjRGF0YSk7XG4gICAgICAgICAgICBwYXRoLnB1c2godmFsdWUpO1xuICAgICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBwYXRoLmpvaW4ocGl2b3RLZXlzLmNvbHVtbkRpbWVuc2lvblNlcGFyYXRvcik7XG4gICAgICAgICAgICBjb25zdCBuZXdPYmogPSB7IHZhbHVlOiBuZXdWYWx1ZSwgZXhwYW5kYWJsZTogY29sLmV4cGFuZGFibGUsIGNoaWxkcmVuOiBudWxsLCBkaW1lbnNpb246IGNvbCB9O1xuICAgICAgICAgICAgaWYgKCFuZXdPYmouY2hpbGRyZW4pIHtcbiAgICAgICAgICAgICAgICBuZXdPYmouY2hpbGRyZW4gPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbHZsQ29sbGVjdGlvbi5zZXQobmV3VmFsdWUsIG5ld09iaik7XG4gICAgICAgICAgICBsdmxDb2xsZWN0aW9uID0gbmV3T2JqLmNoaWxkcmVuO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWxzO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZmxhdHRlbihhcnIsIGx2bCA9IDApIHtcbiAgICAgICAgY29uc3QgbmV3QXJyID0gYXJyLnJlZHVjZSgoYWNjLCBpdGVtKSA9PiB7XG4gICAgICAgICAgICBpdGVtLmxldmVsID0gbHZsO1xuICAgICAgICAgICAgYWNjLnB1c2goaXRlbSk7XG4gICAgICAgICAgICBpZiAoaXRlbS5jaGlsZExldmVsKSB7XG4gICAgICAgICAgICAgICAgaXRlbS5leHBhbmRhYmxlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBhY2MgPSBhY2MuY29uY2F0KHRoaXMuZmxhdHRlbihbaXRlbS5jaGlsZExldmVsXSwgbHZsICsgMSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgfSwgW10pO1xuICAgICAgICByZXR1cm4gbmV3QXJyO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgYXBwbHlBZ2dyZWdhdGlvbnMocmVjOiBJUGl2b3RHcmlkUmVjb3JkLCBoaWVyYXJjaGllcywgdmFsdWVzLCBwaXZvdEtleXM6IElQaXZvdEtleXMpIHtcbiAgICAgICAgaWYgKGhpZXJhcmNoaWVzLnNpemUgPT09IDApIHtcbiAgICAgICAgICAgIC8vIG5vIGNvbHVtbiBncm91cHNcbiAgICAgICAgICAgIGNvbnN0IGFnZ3JlZ2F0aW9uUmVzdWx0ID0gdGhpcy5hZ2dyZWdhdGUocmVjLnJlY29yZHMsIHZhbHVlcyk7XG4gICAgICAgICAgICB0aGlzLmFwcGx5QWdncmVnYXRpb25SZWNvcmREYXRhKGFnZ3JlZ2F0aW9uUmVzdWx0LCB1bmRlZmluZWQsIHJlYywgcGl2b3RLZXlzKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBoaWVyYXJjaGllcy5mb3JFYWNoKChoaWVyYXJjaHkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkcmVuID0gaGllcmFyY2h5W3Bpdm90S2V5cy5jaGlsZHJlbl07XG4gICAgICAgICAgICBpZiAoY2hpbGRyZW4gJiYgY2hpbGRyZW4uc2l6ZSA+IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGx5QWdncmVnYXRpb25zKHJlYywgY2hpbGRyZW4sIHZhbHVlcywgcGl2b3RLZXlzKTtcbiAgICAgICAgICAgICAgICBjb25zdCBjaGlsZFJlY29yZHMgPSB0aGlzLmNvbGxlY3RSZWNvcmRzKGNoaWxkcmVuLCBwaXZvdEtleXMpO1xuICAgICAgICAgICAgICAgIGhpZXJhcmNoeVtwaXZvdEtleXMuYWdncmVnYXRpb25zXSA9IHRoaXMuYWdncmVnYXRlKGNoaWxkUmVjb3JkcywgdmFsdWVzKTtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGx5QWdncmVnYXRpb25SZWNvcmREYXRhKGhpZXJhcmNoeVtwaXZvdEtleXMuYWdncmVnYXRpb25zXSwgaGllcmFyY2h5LnZhbHVlLCByZWMsIHBpdm90S2V5cyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGhpZXJhcmNoeVtwaXZvdEtleXMucmVjb3Jkc10pIHtcbiAgICAgICAgICAgICAgICBoaWVyYXJjaHlbcGl2b3RLZXlzLmFnZ3JlZ2F0aW9uc10gPSB0aGlzLmFnZ3JlZ2F0ZShoaWVyYXJjaHlbcGl2b3RLZXlzLnJlY29yZHNdLCB2YWx1ZXMpO1xuICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlBZ2dyZWdhdGlvblJlY29yZERhdGEoaGllcmFyY2h5W3Bpdm90S2V5cy5hZ2dyZWdhdGlvbnNdLCBoaWVyYXJjaHkudmFsdWUsIHJlYywgcGl2b3RLZXlzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHN0YXRpYyBhcHBseUFnZ3JlZ2F0aW9uUmVjb3JkRGF0YShhZ2dyZWdhdGlvbkRhdGE6IGFueSwgZ3JvdXBOYW1lOiBzdHJpbmcsIHJlYzogSVBpdm90R3JpZFJlY29yZCwgcGl2b3RLZXlzOiBJUGl2b3RLZXlzKSB7XG4gICAgICAgIGNvbnN0IGFnZ3JlZ2F0aW9uS2V5cyA9IE9iamVjdC5rZXlzKGFnZ3JlZ2F0aW9uRGF0YSk7XG4gICAgICAgIGlmIChhZ2dyZWdhdGlvbktleXMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgYWdncmVnYXRpb25LZXlzLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFnZ3JlZ2F0aW9uS2V5ID0gZ3JvdXBOYW1lID8gZ3JvdXBOYW1lICsgcGl2b3RLZXlzLmNvbHVtbkRpbWVuc2lvblNlcGFyYXRvciArIGtleSA6IGtleTtcbiAgICAgICAgICAgICAgICByZWMuYWdncmVnYXRpb25WYWx1ZXMuc2V0KGFnZ3JlZ2F0aW9uS2V5LCBhZ2dyZWdhdGlvbkRhdGFba2V5XSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlICBpZiAoYWdncmVnYXRpb25LZXlzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgY29uc3QgYWdncmVnYXRpb25LZXkgPSBhZ2dyZWdhdGlvbktleXNbMF07XG4gICAgICAgICAgICByZWMuYWdncmVnYXRpb25WYWx1ZXMuc2V0KGdyb3VwTmFtZSB8fCBhZ2dyZWdhdGlvbktleSwgYWdncmVnYXRpb25EYXRhW2FnZ3JlZ2F0aW9uS2V5XSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGFnZ3JlZ2F0ZShyZWNvcmRzLCB2YWx1ZXM6IElQaXZvdFZhbHVlW10pIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgICAgIGZvciAoY29uc3QgcGl2b3RWYWx1ZSBvZiB2YWx1ZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IGFnZ3JlZ2F0b3IgPSBQaXZvdFV0aWwuZ2V0QWdncmVnYXRvckZvclR5cGUocGl2b3RWYWx1ZS5hZ2dyZWdhdGUsIHBpdm90VmFsdWUuZGF0YVR5cGUpO1xuICAgICAgICAgICAgaWYgKCFhZ2dyZWdhdG9yKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgQ3VycmVudFJlc291cmNlU3RyaW5ncy5HcmlkUmVzU3RyaW5ncy5pZ3hfZ3JpZF9waXZvdF9ub19hZ2dyZWdhdG9yLnJlcGxhY2UoXCJ7MH1cIiwgcGl2b3RWYWx1ZS5tZW1iZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVzdWx0W3Bpdm90VmFsdWUubWVtYmVyXSA9IGFnZ3JlZ2F0b3IocmVjb3Jkcy5tYXAociA9PiByW3Bpdm90VmFsdWUubWVtYmVyXSksIHJlY29yZHMpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldEFnZ3JlZ2F0b3JGb3JUeXBlKGFnZ3JlZ2F0ZTogSVBpdm90QWdncmVnYXRvciwgZGF0YVR5cGU6IEdyaWRDb2x1bW5EYXRhVHlwZSkge1xuICAgICAgICBsZXQgYWdncmVnYXRvciA9IGFnZ3JlZ2F0ZS5hZ2dyZWdhdG9yO1xuICAgICAgICBpZiAoYWdncmVnYXRlLmFnZ3JlZ2F0b3JOYW1lKSB7XG4gICAgICAgICAgICBsZXQgYWdncmVnYXRvcnMgPSBJZ3hQaXZvdE51bWVyaWNBZ2dyZWdhdGUuYWdncmVnYXRvcnMoKTtcbiAgICAgICAgICAgIGlmICghZGF0YVR5cGUgfHwgZGF0YVR5cGUgPT09ICdkYXRlJyB8fCBkYXRhVHlwZSA9PT0gJ2RhdGVUaW1lJykge1xuICAgICAgICAgICAgICAgIGFnZ3JlZ2F0b3JzID0gYWdncmVnYXRvcnMuY29uY2F0KElneFBpdm90RGF0ZUFnZ3JlZ2F0ZS5hZ2dyZWdhdG9ycygpKVxuICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhVHlwZSA9PT0gJ3RpbWUnKSB7XG4gICAgICAgICAgICAgICAgYWdncmVnYXRvcnMgPSBhZ2dyZWdhdG9ycy5jb25jYXQoSWd4UGl2b3RUaW1lQWdncmVnYXRlLmFnZ3JlZ2F0b3JzKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYWdncmVnYXRvciA9IGFnZ3JlZ2F0b3JzLmZpbmQoeCA9PiB4LmtleSA9PT0gYWdncmVnYXRlLmFnZ3JlZ2F0b3JOYW1lKT8uYWdncmVnYXRvcjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWdncmVnYXRvcjtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIHByb2Nlc3NIaWVyYXJjaHkoaGllcmFyY2hpZXMsIHBpdm90S2V5cywgbGV2ZWwgPSAwLCByb290RGF0YSA9IGZhbHNlKTogSVBpdm90R3JpZFJlY29yZFtdIHtcbiAgICAgICAgY29uc3QgZmxhdERhdGE6IElQaXZvdEdyaWRSZWNvcmRbXSA9IFtdO1xuICAgICAgICBoaWVyYXJjaGllcy5mb3JFYWNoKChoLCBrZXkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGZpZWxkID0gaC5kaW1lbnNpb24ubWVtYmVyTmFtZTtcbiAgICAgICAgICAgIGNvbnN0IHJlYzogSVBpdm90R3JpZFJlY29yZCA9IHtcbiAgICAgICAgICAgICAgICBkaW1lbnNpb25WYWx1ZXM6IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCksXG4gICAgICAgICAgICAgICAgYWdncmVnYXRpb25WYWx1ZXM6IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCksXG4gICAgICAgICAgICAgICAgY2hpbGRyZW46IG5ldyBNYXA8c3RyaW5nLCBJUGl2b3RHcmlkUmVjb3JkW10+KCksXG4gICAgICAgICAgICAgICAgZGltZW5zaW9uczogW2guZGltZW5zaW9uXVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHJlYy5kaW1lbnNpb25WYWx1ZXMuc2V0KGZpZWxkLCBrZXkpO1xuICAgICAgICAgICAgaWYgKGhbcGl2b3RLZXlzLnJlY29yZHNdKSB7XG4gICAgICAgICAgICAgICAgcmVjLnJlY29yZHMgPSB0aGlzLmdldERpcmVjdExlYWZzKGhbcGl2b3RLZXlzLnJlY29yZHNdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlYy5sZXZlbCA9IGxldmVsO1xuICAgICAgICAgICAgZmxhdERhdGEucHVzaChyZWMpO1xuICAgICAgICAgICAgaWYgKGhbcGl2b3RLZXlzLmNoaWxkcmVuXSAmJiBoW3Bpdm90S2V5cy5jaGlsZHJlbl0uc2l6ZSA+IDApIHtcbiAgICAgICAgICAgICAgICBjb25zdCBuZXN0ZWREYXRhID0gdGhpcy5wcm9jZXNzSGllcmFyY2h5KGhbcGl2b3RLZXlzLmNoaWxkcmVuXSxcbiAgICAgICAgICAgICAgICAgICAgcGl2b3RLZXlzLCBsZXZlbCArIDEsIHJvb3REYXRhKTtcbiAgICAgICAgICAgICAgICByZWMucmVjb3JkcyA9IHRoaXMuZ2V0RGlyZWN0TGVhZnMobmVzdGVkRGF0YSk7XG4gICAgICAgICAgICAgICAgcmVjLmNoaWxkcmVuLnNldChmaWVsZCwgbmVzdGVkRGF0YSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBmbGF0RGF0YTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldERpcmVjdExlYWZzKHJlY29yZHM6IElQaXZvdEdyaWRSZWNvcmRbXSkge1xuICAgICAgICBsZXQgbGVhZnMgPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCByZWMgb2YgcmVjb3Jkcykge1xuICAgICAgICAgICAgaWYgKHJlYy5yZWNvcmRzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHJlYy5yZWNvcmRzLmZpbHRlcih4ID0+ICF4LnJlY29yZHMgJiYgbGVhZnMuaW5kZXhPZih4KSA9PT0gLTEpO1xuICAgICAgICAgICAgICAgIGxlYWZzID0gbGVhZnMuY29uY2F0KGRhdGEpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsZWFmcy5wdXNoKHJlYyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGxlYWZzO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0UmVjb3JkS2V5KHJlYzogSVBpdm90R3JpZFJlY29yZCwgY3VycmVudERpbTogSVBpdm90RGltZW5zaW9uLCkge1xuICAgICAgICBjb25zdCBwYXJlbnRGaWVsZHMgPSBbXTtcbiAgICAgICAgY29uc3QgY3VycmVudERpbUluZGV4ID0gcmVjLmRpbWVuc2lvbnMuZmluZEluZGV4KHggPT4geC5tZW1iZXJOYW1lID09PSBjdXJyZW50RGltLm1lbWJlck5hbWUpICsgMTtcbiAgICAgICAgY29uc3QgcHJldkRpbXMgPSByZWMuZGltZW5zaW9ucy5zbGljZSgwLCBjdXJyZW50RGltSW5kZXgpO1xuICAgICAgICBmb3IgKGNvbnN0IHByZXYgb2YgcHJldkRpbXMpIHtcbiAgICAgICAgICAgIGNvbnN0IHByZXZWYWx1ZSA9IHJlYy5kaW1lbnNpb25WYWx1ZXMuZ2V0KHByZXYubWVtYmVyTmFtZSk7XG4gICAgICAgICAgICBwYXJlbnRGaWVsZHMucHVzaChwcmV2VmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBwYXJlbnRGaWVsZHMuam9pbignLScpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgYnVpbGRFeHByZXNzaW9uVHJlZShjb25maWc6IElQaXZvdENvbmZpZ3VyYXRpb24pIHtcbiAgICAgICAgY29uc3QgYWxsRGltZW5zaW9ucyA9IChjb25maWc/LnJvd3MgfHwgW10pLmNvbmNhdCgoY29uZmlnPy5jb2x1bW5zIHx8IFtdKSkuY29uY2F0KGNvbmZpZz8uZmlsdGVycyB8fCBbXSkuZmlsdGVyKHggPT4geCAhPT0gbnVsbCAmJiB4ICE9PSB1bmRlZmluZWQpO1xuICAgICAgICBjb25zdCBlbmFibGVkRGltZW5zaW9ucyA9IGFsbERpbWVuc2lvbnMuZmlsdGVyKHggPT4geCAmJiB4LmVuYWJsZWQpO1xuXG4gICAgICAgIGNvbnN0IGV4cHJlc3Npb25zVHJlZSA9IG5ldyBGaWx0ZXJpbmdFeHByZXNzaW9uc1RyZWUoRmlsdGVyaW5nTG9naWMuQW5kKTtcbiAgICAgICAgLy8gYWRkIGV4cHJlc3Npb24gdHJlZXMgZnJvbSBhbGwgZmlsdGVyc1xuICAgICAgICBQaXZvdFV0aWwuZmxhdHRlbihlbmFibGVkRGltZW5zaW9ucykuZm9yRWFjaCgoeDogSVBpdm90RGltZW5zaW9uKSA9PiB7XG4gICAgICAgICAgICBpZiAoeC5maWx0ZXIgJiYgeC5maWx0ZXIuZmlsdGVyaW5nT3BlcmFuZHMpIHtcbiAgICAgICAgICAgICAgICBleHByZXNzaW9uc1RyZWUuZmlsdGVyaW5nT3BlcmFuZHMucHVzaCguLi54LmZpbHRlci5maWx0ZXJpbmdPcGVyYW5kcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBleHByZXNzaW9uc1RyZWU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgY29sbGVjdFJlY29yZHMoY2hpbGRyZW4sIHBpdm90S2V5czogSVBpdm90S2V5cykge1xuICAgICAgICBsZXQgcmVzdWx0ID0gW107XG4gICAgICAgIGNoaWxkcmVuLmZvckVhY2godmFsdWUgPT4gcmVzdWx0ID0gcmVzdWx0LmNvbmNhdCh2YWx1ZVtwaXZvdEtleXMucmVjb3Jkc10pKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBhcHBseUhpZXJhcmNoeUNoaWxkcmVuKGhpZXJhcmNoeSwgdmFsLCByZWMsIHBpdm90S2V5czogSVBpdm90S2V5cykge1xuICAgICAgICBjb25zdCByZWNvcmRzS2V5ID0gcGl2b3RLZXlzLnJlY29yZHM7XG4gICAgICAgIGNvbnN0IGNoaWxkS2V5ID0gcGl2b3RLZXlzLmNoaWxkcmVuO1xuICAgICAgICBjb25zdCBjaGlsZENvbGxlY3Rpb24gPSB2YWxbY2hpbGRLZXldO1xuICAgICAgICBjb25zdCBoaWVyYXJjaHlWYWx1ZSA9IGhpZXJhcmNoeS5nZXQodmFsLnZhbHVlKTtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaGllcmFyY2h5VmFsdWVbY2hpbGRLZXldKSkge1xuICAgICAgICAgICAgaGllcmFyY2h5VmFsdWVbY2hpbGRLZXldID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIWNoaWxkQ29sbGVjdGlvbiB8fCBjaGlsZENvbGxlY3Rpb24uc2l6ZSA9PT0gMCkge1xuICAgICAgICAgICAgY29uc3QgZGltID0gaGllcmFyY2h5VmFsdWUuZGltZW5zaW9uO1xuICAgICAgICAgICAgY29uc3QgaXNWYWxpZCA9IHRoaXMuZXh0cmFjdFZhbHVlRnJvbURpbWVuc2lvbihkaW0sIHJlYykgPT09IHZhbC52YWx1ZTtcbiAgICAgICAgICAgIGlmIChpc1ZhbGlkKSB7XG4gICAgICAgICAgICAgICAgaWYgKGhpZXJhcmNoeVZhbHVlW3JlY29yZHNLZXldKSB7XG4gICAgICAgICAgICAgICAgICAgIGhpZXJhcmNoeVZhbHVlW3JlY29yZHNLZXldLnB1c2gocmVjKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBoaWVyYXJjaHlWYWx1ZVtyZWNvcmRzS2V5XSA9IFtyZWNdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGhpZXJhcmNoeUNoaWxkID0gaGllcmFyY2h5VmFsdWVbY2hpbGRLZXldO1xuICAgICAgICAgICAgZm9yIChjb25zdCBbX2tleSwgY2hpbGRdIG9mIGNoaWxkQ29sbGVjdGlvbikge1xuICAgICAgICAgICAgICAgIGxldCBoaWVyYXJjaHlDaGlsZFZhbHVlID0gaGllcmFyY2h5Q2hpbGQuZ2V0KGNoaWxkLnZhbHVlKTtcbiAgICAgICAgICAgICAgICBpZiAoIWhpZXJhcmNoeUNoaWxkVmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgaGllcmFyY2h5Q2hpbGQuc2V0KGNoaWxkLnZhbHVlLCBjaGlsZCk7XG4gICAgICAgICAgICAgICAgICAgIGhpZXJhcmNoeUNoaWxkVmFsdWUgPSBjaGlsZDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoaGllcmFyY2h5Q2hpbGRWYWx1ZVtyZWNvcmRzS2V5XSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb3B5ID0gT2JqZWN0LmFzc2lnbih7fSwgcmVjKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlY1tyZWNvcmRzS2V5XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm90IGFsbCBuZXN0ZWQgY2hpbGRyZW4gYXJlIHZhbGlkXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXN0ZWRWYWx1ZSA9IGhpZXJhcmNoeUNoaWxkVmFsdWUudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaW1lbnNpb24gPSBoaWVyYXJjaHlDaGlsZFZhbHVlLmRpbWVuc2lvbjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkUmVjcyA9IHJlY1tyZWNvcmRzS2V5XS5maWx0ZXIoeCA9PiB0aGlzLmV4dHJhY3RWYWx1ZUZyb21EaW1lbnNpb24oZGltZW5zaW9uLCB4KSA9PT0gbmVzdGVkVmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29weVtyZWNvcmRzS2V5XSA9IHZhbGlkUmVjcztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBoaWVyYXJjaHlDaGlsZFZhbHVlW3JlY29yZHNLZXldLnB1c2goY29weSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaGllcmFyY2h5Q2hpbGRWYWx1ZVtyZWNvcmRzS2V5XSA9IFtyZWNdO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChjaGlsZFtjaGlsZEtleV0gJiYgY2hpbGRbY2hpbGRLZXldLnNpemUgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlIaWVyYXJjaHlDaGlsZHJlbihoaWVyYXJjaHlDaGlsZCwgY2hpbGQsIHJlYywgcGl2b3RLZXlzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldEFnZ3JlZ2F0ZUxpc3QodmFsOiBJUGl2b3RWYWx1ZSwgZ3JpZDogUGl2b3RHcmlkVHlwZSk6IElQaXZvdEFnZ3JlZ2F0b3JbXSB7XG4gICAgICAgIGlmICghdmFsLmFnZ3JlZ2F0ZUxpc3QpIHtcbiAgICAgICAgICAgIGxldCBkZWZhdWx0QWdnciA9IHRoaXMuZ2V0QWdncmVnYXRvcnNGb3JWYWx1ZSh2YWwsIGdyaWQpO1xuICAgICAgICAgICAgY29uc3QgaXNEZWZhdWx0ID0gZGVmYXVsdEFnZ3IuZmluZChcbiAgICAgICAgICAgICAgICAoeCkgPT4geC5rZXkgPT09IHZhbC5hZ2dyZWdhdGUua2V5XG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgLy8gcmVzb2x2ZSBjdXN0b20gYWdncmVnYXRpb25zXG4gICAgICAgICAgICBpZiAoIWlzRGVmYXVsdCAmJiBncmlkLmRhdGFbMF1bdmFsLm1lbWJlcl0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIC8vIGlmIGZpZWxkIGV4aXN0cywgdGhlbiB3ZSBjYW4gYXBwbHkgZGVmYXVsdCBhZ2dyZWdhdGlvbnMgYW5kIGFkZCB0aGUgY3VzdG9tIG9uZS5cbiAgICAgICAgICAgICAgICBkZWZhdWx0QWdnci51bnNoaWZ0KHZhbC5hZ2dyZWdhdGUpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICghaXNEZWZhdWx0KSB7XG4gICAgICAgICAgICAgICAgLy8gb3RoZXJ3aXNlIHRoaXMgaXMgYSBjdXN0b20gYWdncmVnYXRpb24gdGhhdCBpcyBub3QgY29tcGF0aWJsZVxuICAgICAgICAgICAgICAgIC8vIHdpdGggdGhlIGRlZmF1bHRzLCBzaW5jZSBpdCBvcGVyYXRlcyBvbiBmaWVsZCB0aGF0IGlzIG5vdCBpbiB0aGUgZGF0YVxuICAgICAgICAgICAgICAgIC8vIGxlYXZlIG9ubHkgdGhlIGN1c3RvbSBvbmUuXG4gICAgICAgICAgICAgICAgZGVmYXVsdEFnZ3IgPSBbdmFsLmFnZ3JlZ2F0ZV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YWwuYWdncmVnYXRlTGlzdCA9IGRlZmF1bHRBZ2dyO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWwuYWdncmVnYXRlTGlzdDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldEFnZ3JlZ2F0b3JzRm9yVmFsdWUodmFsdWU6IElQaXZvdFZhbHVlLCBncmlkOiBQaXZvdEdyaWRUeXBlKTogSVBpdm90QWdncmVnYXRvcltdIHtcbiAgICAgICAgY29uc3QgZGF0YVR5cGUgPSB2YWx1ZS5kYXRhVHlwZSB8fCBncmlkLnJlc29sdmVEYXRhVHlwZXMoZ3JpZC5kYXRhWzBdW3ZhbHVlLm1lbWJlcl0pO1xuICAgICAgICBzd2l0Y2ggKGRhdGFUeXBlKSB7XG4gICAgICAgICAgICBjYXNlIEdyaWRDb2x1bW5EYXRhVHlwZS5OdW1iZXI6XG4gICAgICAgICAgICBjYXNlIEdyaWRDb2x1bW5EYXRhVHlwZS5DdXJyZW5jeTpcbiAgICAgICAgICAgICAgICByZXR1cm4gSWd4UGl2b3ROdW1lcmljQWdncmVnYXRlLmFnZ3JlZ2F0b3JzKCk7XG4gICAgICAgICAgICBjYXNlIEdyaWRDb2x1bW5EYXRhVHlwZS5EYXRlOlxuICAgICAgICAgICAgY2FzZSBHcmlkQ29sdW1uRGF0YVR5cGUuRGF0ZVRpbWU6XG4gICAgICAgICAgICAgICAgcmV0dXJuIElneFBpdm90RGF0ZUFnZ3JlZ2F0ZS5hZ2dyZWdhdG9ycygpO1xuICAgICAgICAgICAgY2FzZSBHcmlkQ29sdW1uRGF0YVR5cGUuVGltZTpcbiAgICAgICAgICAgICAgICByZXR1cm4gSWd4UGl2b3RUaW1lQWdncmVnYXRlLmFnZ3JlZ2F0b3JzKCk7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHJldHVybiBJZ3hQaXZvdEFnZ3JlZ2F0ZS5hZ2dyZWdhdG9ycygpO1xuICAgICAgICB9XG4gICAgfVxuXG5cbn1cbiJdfQ==