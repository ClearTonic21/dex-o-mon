import { Pipe, Inject } from '@angular/core';
import { DatePipe } from '@angular/common';
import { IGX_TIME_PICKER_COMPONENT } from './time-picker.common';
import { DatePart } from '../directives/date-time-editor/public_api';
import { DateTimeUtil } from '../date-common/util/date-time.util';
import * as i0 from "@angular/core";
const ITEMS_COUNT = 7;
export class TimeFormatPipe {
    constructor(timePicker) {
        this.timePicker = timePicker;
    }
    transform(value) {
        const format = this.timePicker.inputFormat.replace('tt', 'aa');
        const datePipe = new DatePipe(this.timePicker.locale);
        return datePipe.transform(value, format);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: TimeFormatPipe, deps: [{ token: IGX_TIME_PICKER_COMPONENT }], target: i0.ɵɵFactoryTarget.Pipe }); }
    static { this.ɵpipe = i0.ɵɵngDeclarePipe({ minVersion: "14.0.0", version: "18.0.1", ngImport: i0, type: TimeFormatPipe, isStandalone: true, name: "timeFormatPipe" }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: TimeFormatPipe, decorators: [{
            type: Pipe,
            args: [{
                    name: 'timeFormatPipe',
                    standalone: true
                }]
        }], ctorParameters: () => [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [IGX_TIME_PICKER_COMPONENT]
                }] }] });
export class TimeItemPipe {
    constructor(timePicker) {
        this.timePicker = timePicker;
    }
    transform(_collection, timePart, selectedDate, min, max) {
        let list;
        let part;
        switch (timePart) {
            case 'hour':
                list = this.generateHours(min, max);
                const hours = this.timePicker.isTwelveHourFormat ? this.toTwelveHourFormat(selectedDate.getHours())
                    : selectedDate.getHours();
                list = this.scrollListItem(hours, list);
                part = DatePart.Hours;
                break;
            case 'minutes':
                list = this.generateMinutes(selectedDate, min, max);
                list = this.scrollListItem(selectedDate.getMinutes(), list);
                part = DatePart.Minutes;
                break;
            case 'seconds':
                list = this.generateSeconds(selectedDate, min, max);
                list = this.scrollListItem(selectedDate.getSeconds(), list);
                part = DatePart.Seconds;
                break;
            case 'ampm':
                const selectedAmPm = this.timePicker.getPartValue(selectedDate, 'ampm');
                list = this.generateAmPm(min, max, selectedAmPm);
                list = this.scrollListItem(selectedAmPm, list);
                part = DatePart.AmPm;
                break;
        }
        return this.getListView(list, part);
    }
    getListView(view, dateType) {
        for (let i = 0; i < view.length; i++) {
            view[i] = this.getItemView(view[i], dateType);
        }
        return view;
    }
    getItemView(item, dateType) {
        if (item === null) {
            item = '';
        }
        else if (dateType && typeof (item) !== 'string') {
            const leadZeroHour = (item < 10 && (this.timePicker.inputFormat.indexOf('hh') !== -1
                || this.timePicker.inputFormat.indexOf('HH') !== -1));
            const leadZeroMinute = (item < 10 && this.timePicker.inputFormat.indexOf('mm') !== -1);
            const leadZeroSeconds = (item < 10 && this.timePicker.inputFormat.indexOf('ss') !== -1);
            const leadZero = {
                hours: leadZeroHour,
                minutes: leadZeroMinute,
                seconds: leadZeroSeconds
            }[dateType];
            item = (leadZero) ? '0' + item : `${item}`;
        }
        return item;
    }
    scrollListItem(item, items) {
        const itemsCount = items.length;
        let view;
        if (items) {
            const index = items.indexOf(item);
            if (index < 3) {
                view = items.slice(itemsCount - (3 - index), itemsCount);
                view = view.concat(items.slice(0, index + 4));
            }
            else if (index + 4 > itemsCount) {
                view = items.slice(index - 3, itemsCount);
                view = view.concat(items.slice(0, index + 4 - itemsCount));
            }
            else {
                view = items.slice(index - 3, index + 4);
            }
        }
        return view;
    }
    generateHours(min, max) {
        const hourItems = [];
        let hoursCount = this.timePicker.isTwelveHourFormat ? 13 : 24;
        hoursCount /= this.timePicker.itemsDelta.hours;
        const minHours = min.getHours();
        const maxHours = max.getHours();
        if (hoursCount > 1) {
            for (let hourIndex = 0; hourIndex < 24; hourIndex++) {
                let hours = hourIndex * this.timePicker.itemsDelta.hours;
                if (hours >= minHours && hours <= maxHours) {
                    hours = this.timePicker.isTwelveHourFormat ? this.toTwelveHourFormat(hours) : hours;
                    if (!hourItems.find((element => element === hours))) {
                        hourItems.push(hours);
                    }
                }
            }
        }
        else {
            hourItems.push(0);
        }
        if (hourItems.length < ITEMS_COUNT || hoursCount < ITEMS_COUNT || !this.timePicker.spinLoop) {
            const index = !this.timePicker.spinLoop || (hourItems.length < ITEMS_COUNT && hoursCount < ITEMS_COUNT) ? 6 : 3;
            for (let i = 0; i < index; i++) {
                hourItems.push(null);
            }
        }
        return hourItems;
    }
    generateMinutes(time, min, max) {
        const minuteItems = [];
        const minuteItemsCount = 60 / this.timePicker.itemsDelta.minutes;
        time = new Date(time);
        for (let i = 0; i < minuteItemsCount; i++) {
            const minutes = i * this.timePicker.itemsDelta.minutes;
            time.setMinutes(minutes);
            if (time >= min && time <= max) {
                minuteItems.push(i * this.timePicker.itemsDelta.minutes);
            }
        }
        if (minuteItems.length < ITEMS_COUNT || minuteItemsCount < ITEMS_COUNT || !this.timePicker.spinLoop) {
            const index = !this.timePicker.spinLoop || (minuteItems.length < ITEMS_COUNT && minuteItemsCount < ITEMS_COUNT) ? 6 : 3;
            for (let i = 0; i < index; i++) {
                minuteItems.push(null);
            }
        }
        return minuteItems;
    }
    generateSeconds(time, min, max) {
        const secondsItems = [];
        const secondsItemsCount = 60 / this.timePicker.itemsDelta.seconds;
        time = new Date(time);
        for (let i = 0; i < secondsItemsCount; i++) {
            const seconds = i * this.timePicker.itemsDelta.seconds;
            time.setSeconds(seconds);
            if (time.getTime() >= min.getTime()
                && time.getTime() <= max.getTime()) {
                secondsItems.push(i * this.timePicker.itemsDelta.seconds);
            }
        }
        if (secondsItems.length < ITEMS_COUNT || secondsItemsCount < ITEMS_COUNT || !this.timePicker.spinLoop) {
            const index = !this.timePicker.spinLoop || (secondsItems.length < ITEMS_COUNT && secondsItemsCount < ITEMS_COUNT) ? 6 : 3;
            for (let i = 0; i < index; i++) {
                secondsItems.push(null);
            }
        }
        return secondsItems;
    }
    generateAmPm(min, max, selectedAmPm) {
        const ampmItems = [];
        const minHour = min.getHours();
        const maxHour = max.getHours();
        if (minHour < 12) {
            ampmItems.push(DateTimeUtil.getAmPmValue(selectedAmPm.length, true));
        }
        if (minHour >= 12 || maxHour >= 12) {
            ampmItems.push(DateTimeUtil.getAmPmValue(selectedAmPm.length, false));
        }
        for (let i = 0; i < 5; i++) {
            ampmItems.push(null);
        }
        return ampmItems;
    }
    toTwelveHourFormat(hour) {
        if (hour > 12) {
            hour -= 12;
        }
        else if (hour === 0) {
            hour = 12;
        }
        return hour;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: TimeItemPipe, deps: [{ token: IGX_TIME_PICKER_COMPONENT }], target: i0.ɵɵFactoryTarget.Pipe }); }
    static { this.ɵpipe = i0.ɵɵngDeclarePipe({ minVersion: "14.0.0", version: "18.0.1", ngImport: i0, type: TimeItemPipe, isStandalone: true, name: "timeItemPipe" }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: TimeItemPipe, decorators: [{
            type: Pipe,
            args: [{
                    name: 'timeItemPipe',
                    standalone: true
                }]
        }], ctorParameters: () => [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [IGX_TIME_PICKER_COMPONENT]
                }] }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZS1waWNrZXIucGlwZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9pZ25pdGV1aS1hbmd1bGFyL3NyYy9saWIvdGltZS1waWNrZXIvdGltZS1waWNrZXIucGlwZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLElBQUksRUFBaUIsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzVELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUseUJBQXlCLEVBQXFCLE1BQU0sc0JBQXNCLENBQUM7QUFDcEYsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLDJDQUEyQyxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQzs7QUFFbEUsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBTXRCLE1BQU0sT0FBTyxjQUFjO0lBQ3ZCLFlBQXVELFVBQTZCO1FBQTdCLGVBQVUsR0FBVixVQUFVLENBQW1CO0lBQUksQ0FBQztJQUVsRixTQUFTLENBQUMsS0FBVztRQUN4QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQy9ELE1BQU0sUUFBUSxHQUFHLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdEQsT0FBTyxRQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztJQUM3QyxDQUFDOzhHQVBRLGNBQWMsa0JBQ0gseUJBQXlCOzRHQURwQyxjQUFjOzsyRkFBZCxjQUFjO2tCQUoxQixJQUFJO21CQUFDO29CQUNGLElBQUksRUFBRSxnQkFBZ0I7b0JBQ3RCLFVBQVUsRUFBRSxJQUFJO2lCQUNuQjs7MEJBRWdCLE1BQU07MkJBQUMseUJBQXlC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QUFFLENBQUM7WUFDWixJQUFJLElBQUksRUFBRSxDQUFDO1FBQ2YsQ0FBQzthQUFNLElBQUksSUFBSSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ3BCLElBQUksR0FBRyxFQUFFLENBQUM7UUFDZCxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQzs4R0F6TFEsWUFBWSxrQkFDRCx5QkFBeUI7NEdBRHBDLFlBQVk7OzJGQUFaLFlBQVk7a0JBSnhCLElBQUk7bUJBQUM7b0JBQ0YsSUFBSSxFQUFFLGNBQWM7b0JBQ3BCLFVBQVUsRUFBRSxJQUFJO2lCQUNuQjs7MEJBRWdCLE1BQU07MkJBQUMseUJBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGlwZSwgUGlwZVRyYW5zZm9ybSwgSW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBEYXRlUGlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBJR1hfVElNRV9QSUNLRVJfQ09NUE9ORU5ULCBJZ3hUaW1lUGlja2VyQmFzZSB9IGZyb20gJy4vdGltZS1waWNrZXIuY29tbW9uJztcbmltcG9ydCB7IERhdGVQYXJ0IH0gZnJvbSAnLi4vZGlyZWN0aXZlcy9kYXRlLXRpbWUtZWRpdG9yL3B1YmxpY19hcGknO1xuaW1wb3J0IHsgRGF0ZVRpbWVVdGlsIH0gZnJvbSAnLi4vZGF0ZS1jb21tb24vdXRpbC9kYXRlLXRpbWUudXRpbCc7XG5cbmNvbnN0IElURU1TX0NPVU5UID0gNztcblxuQFBpcGUoe1xuICAgIG5hbWU6ICd0aW1lRm9ybWF0UGlwZScsXG4gICAgc3RhbmRhbG9uZTogdHJ1ZVxufSlcbmV4cG9ydCBjbGFzcyBUaW1lRm9ybWF0UGlwZSBpbXBsZW1lbnRzIFBpcGVUcmFuc2Zvcm0ge1xuICAgIGNvbnN0cnVjdG9yKEBJbmplY3QoSUdYX1RJTUVfUElDS0VSX0NPTVBPTkVOVCkgcHJpdmF0ZSB0aW1lUGlja2VyOiBJZ3hUaW1lUGlja2VyQmFzZSkgeyB9XG5cbiAgICBwdWJsaWMgdHJhbnNmb3JtKHZhbHVlOiBEYXRlKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgZm9ybWF0ID0gdGhpcy50aW1lUGlja2VyLmlucHV0Rm9ybWF0LnJlcGxhY2UoJ3R0JywgJ2FhJyk7XG4gICAgICAgIGNvbnN0IGRhdGVQaXBlID0gbmV3IERhdGVQaXBlKHRoaXMudGltZVBpY2tlci5sb2NhbGUpO1xuICAgICAgICByZXR1cm4gZGF0ZVBpcGUudHJhbnNmb3JtKHZhbHVlLCBmb3JtYXQpO1xuICAgIH1cbn1cblxuQFBpcGUoe1xuICAgIG5hbWU6ICd0aW1lSXRlbVBpcGUnLFxuICAgIHN0YW5kYWxvbmU6IHRydWVcbn0pXG5leHBvcnQgY2xhc3MgVGltZUl0ZW1QaXBlIGltcGxlbWVudHMgUGlwZVRyYW5zZm9ybSB7XG4gICAgY29uc3RydWN0b3IoQEluamVjdChJR1hfVElNRV9QSUNLRVJfQ09NUE9ORU5UKSBwcml2YXRlIHRpbWVQaWNrZXI6IElneFRpbWVQaWNrZXJCYXNlKSB7IH1cblxuICAgIHB1YmxpYyB0cmFuc2Zvcm0oX2NvbGxlY3Rpb246IGFueVtdLCB0aW1lUGFydDogc3RyaW5nLCBzZWxlY3RlZERhdGU6IERhdGUsIG1pbjogRGF0ZSwgbWF4OiBEYXRlKSB7XG4gICAgICAgIGxldCBsaXN0O1xuICAgICAgICBsZXQgcGFydDtcbiAgICAgICAgc3dpdGNoICh0aW1lUGFydCkge1xuICAgICAgICAgICAgY2FzZSAnaG91cic6XG4gICAgICAgICAgICAgICAgbGlzdCA9IHRoaXMuZ2VuZXJhdGVIb3VycyhtaW4sIG1heCk7XG4gICAgICAgICAgICAgICAgY29uc3QgaG91cnMgPSB0aGlzLnRpbWVQaWNrZXIuaXNUd2VsdmVIb3VyRm9ybWF0ID8gdGhpcy50b1R3ZWx2ZUhvdXJGb3JtYXQoc2VsZWN0ZWREYXRlLmdldEhvdXJzKCkpXG4gICAgICAgICAgICAgICAgICAgIDogc2VsZWN0ZWREYXRlLmdldEhvdXJzKCk7XG4gICAgICAgICAgICAgICAgbGlzdCA9IHRoaXMuc2Nyb2xsTGlzdEl0ZW0oaG91cnMsIGxpc3QpO1xuICAgICAgICAgICAgICAgIHBhcnQgPSBEYXRlUGFydC5Ib3VycztcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ21pbnV0ZXMnOlxuICAgICAgICAgICAgICAgIGxpc3QgPSB0aGlzLmdlbmVyYXRlTWludXRlcyhzZWxlY3RlZERhdGUsIG1pbiwgbWF4KTtcbiAgICAgICAgICAgICAgICBsaXN0ID0gdGhpcy5zY3JvbGxMaXN0SXRlbShzZWxlY3RlZERhdGUuZ2V0TWludXRlcygpLCBsaXN0KTtcbiAgICAgICAgICAgICAgICBwYXJ0ID0gRGF0ZVBhcnQuTWludXRlcztcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ3NlY29uZHMnOlxuICAgICAgICAgICAgICAgIGxpc3QgPSB0aGlzLmdlbmVyYXRlU2Vjb25kcyhzZWxlY3RlZERhdGUsIG1pbiwgbWF4KTtcbiAgICAgICAgICAgICAgICBsaXN0ID0gdGhpcy5zY3JvbGxMaXN0SXRlbShzZWxlY3RlZERhdGUuZ2V0U2Vjb25kcygpLCBsaXN0KTtcbiAgICAgICAgICAgICAgICBwYXJ0ID0gRGF0ZVBhcnQuU2Vjb25kcztcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ2FtcG0nOlxuICAgICAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkQW1QbSA9IHRoaXMudGltZVBpY2tlci5nZXRQYXJ0VmFsdWUoc2VsZWN0ZWREYXRlLCAnYW1wbScpO1xuICAgICAgICAgICAgICAgIGxpc3QgPSB0aGlzLmdlbmVyYXRlQW1QbShtaW4sIG1heCwgc2VsZWN0ZWRBbVBtKTtcbiAgICAgICAgICAgICAgICBsaXN0ID0gdGhpcy5zY3JvbGxMaXN0SXRlbShzZWxlY3RlZEFtUG0sIGxpc3QpO1xuICAgICAgICAgICAgICAgIHBhcnQgPSBEYXRlUGFydC5BbVBtO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmdldExpc3RWaWV3KGxpc3QsIHBhcnQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TGlzdFZpZXcodmlldzogYW55LCBkYXRlVHlwZTogRGF0ZVBhcnQpOiBhbnkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZpZXcubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHZpZXdbaV0gPSB0aGlzLmdldEl0ZW1WaWV3KHZpZXdbaV0sIGRhdGVUeXBlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdmlldztcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEl0ZW1WaWV3KGl0ZW06IGFueSwgZGF0ZVR5cGU6IERhdGVQYXJ0KTogc3RyaW5nIHtcbiAgICAgICAgaWYgKGl0ZW0gPT09IG51bGwpIHtcbiAgICAgICAgICAgIGl0ZW0gPSAnJztcbiAgICAgICAgfSBlbHNlIGlmIChkYXRlVHlwZSAmJiB0eXBlb2YgKGl0ZW0pICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgY29uc3QgbGVhZFplcm9Ib3VyID0gKGl0ZW0gPCAxMCAmJiAodGhpcy50aW1lUGlja2VyLmlucHV0Rm9ybWF0LmluZGV4T2YoJ2hoJykgIT09IC0xXG4gICAgICAgICAgICAgICAgfHwgdGhpcy50aW1lUGlja2VyLmlucHV0Rm9ybWF0LmluZGV4T2YoJ0hIJykgIT09IC0xKSk7XG4gICAgICAgICAgICBjb25zdCBsZWFkWmVyb01pbnV0ZSA9IChpdGVtIDwgMTAgJiYgdGhpcy50aW1lUGlja2VyLmlucHV0Rm9ybWF0LmluZGV4T2YoJ21tJykgIT09IC0xKTtcbiAgICAgICAgICAgIGNvbnN0IGxlYWRaZXJvU2Vjb25kcyA9IChpdGVtIDwgMTAgJiYgdGhpcy50aW1lUGlja2VyLmlucHV0Rm9ybWF0LmluZGV4T2YoJ3NzJykgIT09IC0xKTtcblxuICAgICAgICAgICAgY29uc3QgbGVhZFplcm8gPSB7XG4gICAgICAgICAgICAgICAgaG91cnM6IGxlYWRaZXJvSG91cixcbiAgICAgICAgICAgICAgICBtaW51dGVzOiBsZWFkWmVyb01pbnV0ZSxcbiAgICAgICAgICAgICAgICBzZWNvbmRzOiBsZWFkWmVyb1NlY29uZHNcbiAgICAgICAgICAgIH1bZGF0ZVR5cGVdO1xuXG4gICAgICAgICAgICBpdGVtID0gKGxlYWRaZXJvKSA/ICcwJyArIGl0ZW0gOiBgJHtpdGVtfWA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGl0ZW07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzY3JvbGxMaXN0SXRlbShpdGVtOiBudW1iZXIgfCBzdHJpbmcsIGl0ZW1zOiBhbnlbXSk6IGFueVtdIHtcbiAgICAgICAgY29uc3QgaXRlbXNDb3VudCA9IGl0ZW1zLmxlbmd0aDtcbiAgICAgICAgbGV0IHZpZXc7XG4gICAgICAgIGlmIChpdGVtcykge1xuICAgICAgICAgICAgY29uc3QgaW5kZXggPSBpdGVtcy5pbmRleE9mKGl0ZW0pO1xuICAgICAgICAgICAgaWYgKGluZGV4IDwgMykge1xuICAgICAgICAgICAgICAgIHZpZXcgPSBpdGVtcy5zbGljZShpdGVtc0NvdW50IC0gKDMgLSBpbmRleCksIGl0ZW1zQ291bnQpO1xuICAgICAgICAgICAgICAgIHZpZXcgPSB2aWV3LmNvbmNhdChpdGVtcy5zbGljZSgwLCBpbmRleCArIDQpKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggKyA0ID4gaXRlbXNDb3VudCkge1xuICAgICAgICAgICAgICAgIHZpZXcgPSBpdGVtcy5zbGljZShpbmRleCAtIDMsIGl0ZW1zQ291bnQpO1xuICAgICAgICAgICAgICAgIHZpZXcgPSB2aWV3LmNvbmNhdChpdGVtcy5zbGljZSgwLCBpbmRleCArIDQgLSBpdGVtc0NvdW50KSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZpZXcgPSBpdGVtcy5zbGljZShpbmRleCAtIDMsIGluZGV4ICsgNCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZpZXc7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZW5lcmF0ZUhvdXJzKG1pbjogRGF0ZSwgbWF4OiBEYXRlKTogYW55W10ge1xuICAgICAgICBjb25zdCBob3VySXRlbXMgPSBbXTtcbiAgICAgICAgbGV0IGhvdXJzQ291bnQgPSB0aGlzLnRpbWVQaWNrZXIuaXNUd2VsdmVIb3VyRm9ybWF0ID8gMTMgOiAyNDtcbiAgICAgICAgaG91cnNDb3VudCAvPSB0aGlzLnRpbWVQaWNrZXIuaXRlbXNEZWx0YS5ob3VycztcbiAgICAgICAgY29uc3QgbWluSG91cnMgPSBtaW4uZ2V0SG91cnMoKTtcbiAgICAgICAgY29uc3QgbWF4SG91cnMgPSBtYXguZ2V0SG91cnMoKTtcblxuICAgICAgICBpZiAoaG91cnNDb3VudCA+IDEpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGhvdXJJbmRleCA9IDA7IGhvdXJJbmRleCA8IDI0OyBob3VySW5kZXgrKykge1xuICAgICAgICAgICAgICAgIGxldCBob3VycyA9IGhvdXJJbmRleCAqIHRoaXMudGltZVBpY2tlci5pdGVtc0RlbHRhLmhvdXJzO1xuICAgICAgICAgICAgICAgIGlmIChob3VycyA+PSBtaW5Ib3VycyAmJiBob3VycyA8PSBtYXhIb3Vycykge1xuICAgICAgICAgICAgICAgICAgICBob3VycyA9IHRoaXMudGltZVBpY2tlci5pc1R3ZWx2ZUhvdXJGb3JtYXQgPyB0aGlzLnRvVHdlbHZlSG91ckZvcm1hdChob3VycykgOiBob3VycztcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFob3VySXRlbXMuZmluZCgoZWxlbWVudCA9PiBlbGVtZW50ID09PSBob3VycykpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBob3VySXRlbXMucHVzaChob3Vycyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBob3VySXRlbXMucHVzaCgwKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChob3VySXRlbXMubGVuZ3RoIDwgSVRFTVNfQ09VTlQgfHwgaG91cnNDb3VudCA8IElURU1TX0NPVU5UIHx8ICF0aGlzLnRpbWVQaWNrZXIuc3Bpbkxvb3ApIHtcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gIXRoaXMudGltZVBpY2tlci5zcGluTG9vcCB8fCAoaG91ckl0ZW1zLmxlbmd0aCA8IElURU1TX0NPVU5UICYmIGhvdXJzQ291bnQgPCBJVEVNU19DT1VOVCkgPyA2IDogMztcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXg7IGkrKykge1xuICAgICAgICAgICAgICAgIGhvdXJJdGVtcy5wdXNoKG51bGwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGhvdXJJdGVtcztcbiAgICB9XG5cbiAgICBwcml2YXRlIGdlbmVyYXRlTWludXRlcyh0aW1lOiBEYXRlLCBtaW46IERhdGUsIG1heDogRGF0ZSk6IGFueVtdIHtcbiAgICAgICAgY29uc3QgbWludXRlSXRlbXMgPSBbXTtcbiAgICAgICAgY29uc3QgbWludXRlSXRlbXNDb3VudCA9IDYwIC8gdGhpcy50aW1lUGlja2VyLml0ZW1zRGVsdGEubWludXRlcztcbiAgICAgICAgdGltZSA9IG5ldyBEYXRlKHRpbWUpO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWludXRlSXRlbXNDb3VudDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBtaW51dGVzID0gaSAqIHRoaXMudGltZVBpY2tlci5pdGVtc0RlbHRhLm1pbnV0ZXM7XG4gICAgICAgICAgICB0aW1lLnNldE1pbnV0ZXMobWludXRlcyk7XG4gICAgICAgICAgICBpZiAodGltZSA+PSBtaW4gJiYgdGltZSA8PSBtYXgpIHtcbiAgICAgICAgICAgICAgICBtaW51dGVJdGVtcy5wdXNoKGkgKiB0aGlzLnRpbWVQaWNrZXIuaXRlbXNEZWx0YS5taW51dGVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtaW51dGVJdGVtcy5sZW5ndGggPCBJVEVNU19DT1VOVCB8fCBtaW51dGVJdGVtc0NvdW50IDwgSVRFTVNfQ09VTlQgfHwgIXRoaXMudGltZVBpY2tlci5zcGluTG9vcCkge1xuICAgICAgICAgICAgY29uc3QgaW5kZXggPSAhdGhpcy50aW1lUGlja2VyLnNwaW5Mb29wIHx8IChtaW51dGVJdGVtcy5sZW5ndGggPCBJVEVNU19DT1VOVCAmJiBtaW51dGVJdGVtc0NvdW50IDwgSVRFTVNfQ09VTlQpID8gNiA6IDM7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZGV4OyBpKyspIHtcbiAgICAgICAgICAgICAgICBtaW51dGVJdGVtcy5wdXNoKG51bGwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG1pbnV0ZUl0ZW1zO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2VuZXJhdGVTZWNvbmRzKHRpbWU6IERhdGUsIG1pbjogRGF0ZSwgbWF4OiBEYXRlKTogYW55W10ge1xuICAgICAgICBjb25zdCBzZWNvbmRzSXRlbXMgPSBbXTtcbiAgICAgICAgY29uc3Qgc2Vjb25kc0l0ZW1zQ291bnQgPSA2MCAvIHRoaXMudGltZVBpY2tlci5pdGVtc0RlbHRhLnNlY29uZHM7XG4gICAgICAgIHRpbWUgPSBuZXcgRGF0ZSh0aW1lKTtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlY29uZHNJdGVtc0NvdW50OyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IHNlY29uZHMgPSBpICogdGhpcy50aW1lUGlja2VyLml0ZW1zRGVsdGEuc2Vjb25kcztcbiAgICAgICAgICAgIHRpbWUuc2V0U2Vjb25kcyhzZWNvbmRzKTtcbiAgICAgICAgICAgIGlmICh0aW1lLmdldFRpbWUoKSA+PSBtaW4uZ2V0VGltZSgpXG4gICAgICAgICAgICAgICAgJiYgdGltZS5nZXRUaW1lKCkgPD0gbWF4LmdldFRpbWUoKSkge1xuICAgICAgICAgICAgICAgIHNlY29uZHNJdGVtcy5wdXNoKGkgKiB0aGlzLnRpbWVQaWNrZXIuaXRlbXNEZWx0YS5zZWNvbmRzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzZWNvbmRzSXRlbXMubGVuZ3RoIDwgSVRFTVNfQ09VTlQgfHwgc2Vjb25kc0l0ZW1zQ291bnQgPCBJVEVNU19DT1VOVCB8fCAhdGhpcy50aW1lUGlja2VyLnNwaW5Mb29wKSB7XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9ICF0aGlzLnRpbWVQaWNrZXIuc3Bpbkxvb3AgfHwgKHNlY29uZHNJdGVtcy5sZW5ndGggPCBJVEVNU19DT1VOVCAmJiBzZWNvbmRzSXRlbXNDb3VudCA8IElURU1TX0NPVU5UKSA/IDYgOiAzO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRleDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgc2Vjb25kc0l0ZW1zLnB1c2gobnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc2Vjb25kc0l0ZW1zO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2VuZXJhdGVBbVBtKG1pbjogRGF0ZSwgbWF4OiBEYXRlLCBzZWxlY3RlZEFtUG06IHN0cmluZyk6IGFueVtdIHtcbiAgICAgICAgY29uc3QgYW1wbUl0ZW1zID0gW107XG4gICAgICAgIGNvbnN0IG1pbkhvdXIgPSBtaW4uZ2V0SG91cnMoKTtcbiAgICAgICAgY29uc3QgbWF4SG91ciA9IG1heC5nZXRIb3VycygpO1xuXG4gICAgICAgIGlmIChtaW5Ib3VyIDwgMTIpIHtcbiAgICAgICAgICAgIGFtcG1JdGVtcy5wdXNoKERhdGVUaW1lVXRpbC5nZXRBbVBtVmFsdWUoc2VsZWN0ZWRBbVBtLmxlbmd0aCwgdHJ1ZSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG1pbkhvdXIgPj0gMTIgfHwgbWF4SG91ciA+PSAxMikge1xuICAgICAgICAgICAgYW1wbUl0ZW1zLnB1c2goRGF0ZVRpbWVVdGlsLmdldEFtUG1WYWx1ZShzZWxlY3RlZEFtUG0ubGVuZ3RoLCBmYWxzZSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA1OyBpKyspIHtcbiAgICAgICAgICAgIGFtcG1JdGVtcy5wdXNoKG51bGwpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGFtcG1JdGVtcztcbiAgICB9XG5cbiAgICBwcml2YXRlIHRvVHdlbHZlSG91ckZvcm1hdChob3VyOiBudW1iZXIpOiBudW1iZXIge1xuICAgICAgICBpZiAoaG91ciA+IDEyKSB7XG4gICAgICAgICAgICBob3VyIC09IDEyO1xuICAgICAgICB9IGVsc2UgaWYgKGhvdXIgPT09IDApIHtcbiAgICAgICAgICAgIGhvdXIgPSAxMjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBob3VyO1xuICAgIH1cbn1cbiJdfQ==